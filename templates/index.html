<!DOCTYPE html>
<html>
<head>
    <title>Certificate Checker Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .status-bar {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .progress {
            height: 25px;
        }
        .chart-container {
            width: 400px;
            margin: 20px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1>Certificate Checker Dashboard</h1>
        
        <!-- Input Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Input Domains</h5>
                
                <!-- Tab navigation -->
                <ul class="nav nav-tabs mb-3" id="inputTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab" aria-controls="manual" aria-selected="true">
                            Manual Input
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file" type="button" role="tab" aria-controls="file" aria-selected="false">
                            File Upload
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="scheduled-tab" data-bs-toggle="tab" data-bs-target="#scheduled" type="button" role="tab" aria-controls="scheduled" aria-selected="false">
                            Scheduled Scans
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content" id="inputTabsContent">
                    <!-- Manual Input Tab -->
                    <div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
                        <form id="manualForm" class="mt-4">
                            <div class="mb-3">
                                <label for="inputType" class="form-label">Input Type</label>
                                <select class="form-select" id="inputType">
                                    <option value="ip">IP Addresses</option>
                                    <option value="domain">Domain Names</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="inputData" class="form-label">Enter IPs/Domains (one per line)</label>
                                <textarea class="form-control" id="inputData" rows="5" placeholder="Enter one IP or domain per line"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Scan Certificates</button>
                        </form>

                        <div id="progressSection" style="display: none;" class="mt-4">
                            <h4 id="statusText">Starting scan...</h4>
                            <div class="progress" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" 
                                     aria-valuemax="100">0%</div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <div class="row mt-4">
                                <!-- Successful Certificates -->
                                <div class="col-md-6">
                                    <h4>Found Certificates</h4>
                                    <table id="certsTable" class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Target</th>
                                                <th>Status</th>
                                                <th>Valid</th>
                                                <th>Issuer</th>
                                                <th>Expiry</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                
                                <!-- Failed/No Certificates -->
                                <div class="col-md-6">
                                    <h4>Failed/No Certificates</h4>
                                    <table id="failuresTable" class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Target</th>
                                                <th>Status</th>
                                                <th>Error</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Upload Tab -->
                    <div class="tab-pane fade" id="file" role="tabpanel" aria-labelledby="file-tab">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="domainFile" accept=".txt">
                                <small class="text-muted">Upload a .txt file with one domain per line</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload and Check</button>
                        </form>
                    </div>
                    
                    <!-- Scheduled Scans tab content -->
                    <div class="tab-pane fade" id="scheduled" role="tabpanel" aria-labelledby="scheduled-tab">
                        <div class="card mt-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Scheduled Scans</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                                    <i class="fas fa-plus"></i> New Schedule
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Frequency</th>
                                                <th>Time</th>
                                                <th>Next Run</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scheduledTasksTable">
                                            <!-- Will be populated by loadScheduledTasks() -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Add new section for active scans -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">Active Scans</h5>
                            </div>
                            <div class="card-body" id="activeScans">
                                <div class="no-active-scans text-muted">No scans currently running</div>
                                <!-- Active scans will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="statusBar" class="status-bar bg-light">
            <h5>Progress</h5>
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
            <div id="statusText" class="mt-2">Ready to check certificates...</div>
        </div>

        <!-- Charts Section -->
        <div class="row mt-4">
            <div class="col">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="issuerChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="summary-section" style="display: none; margin-bottom: 20px;">
            <h3>Certificate Scan Summary</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Total Domains Scanned:</strong> <span id="total-domains">0</span></p>
                    <p><strong>Domains with Certificates:</strong> <span id="domains-with-certs">0</span></p>
                    <p><strong>Total Certificates Found:</strong> <span id="total-certificates">0</span></p>
                </div>
                <div class="col-md-6">
                    <h4>Certificate Status Breakdown:</h4>
                    <p><strong>Valid Certificates:</strong> <span id="valid-certs">0</span></p>
                    <p><strong>Expiring Soon:</strong> <span id="expiring-soon">0</span></p>
                    <p><strong>Expired:</strong> <span id="expired">0</span></p>
                    <p><strong>Not Yet Valid:</strong> <span id="not-yet-valid">0</span></p>
                </div>
            </div>
        </div>

        <!-- Add Export Buttons -->
        <div class="row mt-3 mb-4">
            <div class="col-12">
                <button id="exportBtn" class="btn btn-success">Export Results to Excel</button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">Schedule Recurring Scan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <div class="mb-3">
                            <label for="scheduleName" class="form-label">Schedule Name</label>
                            <input type="text" class="form-control" id="scheduleName" required>
                        </div>
                        
                        <!-- Update tab IDs and data attributes -->
                        <ul class="nav nav-tabs mb-3" id="scheduleInputTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="manual-domains-tab" data-bs-toggle="tab" 
                                        data-bs-target="#manual-domains" type="button" role="tab">
                                    Manual Input
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="file-domains-tab" data-bs-toggle="tab" 
                                        data-bs-target="#file-domains" type="button" role="tab">
                                    File Upload
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Update tab content IDs -->
                        <div class="tab-content" id="scheduleInputTabsContent">
                            <div class="tab-pane fade show active" id="manual-domains" role="tabpanel">
                                <div class="mb-3">
                                    <label for="scheduleDomains" class="form-label">Domains to Scan</label>
                                    <textarea class="form-control" id="scheduleDomains" rows="4"
                                              placeholder="Enter domains (one per line)"></textarea>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="file-domains" role="tabpanel">
                                <div class="mb-3">
                                    <label for="scheduleDomainFile" class="form-label">Upload Domains File</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="scheduleDomainFile" accept=".txt">
                                        <button class="btn btn-secondary" type="button" id="uploadDomainsButton">
                                            Upload
                                        </button>
                                    </div>
                                    <small class="text-muted">Upload a .txt file with one domain per line</small>
                                    <div id="uploadedDomainsInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-success">
                                            <span id="uploadedDomainsCount">0</span> domains loaded successfully
                                            <button type="button" class="btn-close float-end" aria-label="Close"></button>
                                        </div>
                                        <div class="border rounded p-2 bg-light">
                                            <small class="text-muted">Preview:</small>
                                            <div id="uploadedDomainsList" style="max-height: 100px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="scheduleFrequency" class="form-label">Frequency</label>
                            <select class="form-select" id="scheduleFrequency" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="scheduleTime" required>
                        </div>
                    </form>
                </div>
                <div class="modal-body" id="scheduledTasksList">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Frequency</th>
                                    <th>Time</th>
                                    <th>Next Run</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by loadScheduledTasks() -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSchedule">Save Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize charts
        const statusChart = new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: {
                labels: ['Valid', 'Warning', 'Expired', 'Not Yet Valid'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Certificate Status Distribution'
                    }
                }
            }
        });

        const issuerChart = new Chart(document.getElementById('issuerChart'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Certificates per Issuer',
                    data: [],
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Top Certificate Issuers'
                    }
                }
            }
        });

        function updateResults(results) {
            results.forEach(result => {
                if (result.has_cert) {
                    // Add to certificates table
                    const certsBody = document.querySelector('#certsTable tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${result.ip}</td>
                        <td>${result.status || 'Unknown'}</td>
                        <td>${result.valid ? 'Valid' : 'Invalid'}</td>
                        <td>${result.issuer || 'N/A'}</td>
                        <td>${result.not_after ? new Date(result.not_after).toLocaleDateString() : 'N/A'}</td>
                    `;
                    certsBody.appendChild(row);
                } else {
                    // Add to failures table
                    const failuresBody = document.querySelector('#failuresTable tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${result.ip}</td>
                        <td>${result.status || 'Unknown'}</td>
                        <td>${result.error || 'No Certificate'}</td>
                    `;
                    failuresBody.appendChild(row);
                }
            });
        }

        // Clear both tables when starting new scan
        document.getElementById('manualForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Clear both tables
            document.querySelector('#certsTable tbody').innerHTML = '';
            document.querySelector('#failuresTable tbody').innerHTML = '';
            
            // Show progress section
            const progressSection = document.getElementById('progressSection');
            const statusText = document.getElementById('statusText');
            const progressBar = document.getElementById('progressBar');
            
            progressSection.style.display = 'block';
            statusText.textContent = 'Starting scan...';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            const formData = new FormData();
            const inputType = document.getElementById('inputType').value;
            const inputData = document.getElementById('inputData').value;
            
            if (!inputData.trim()) {
                alert('Please enter at least one IP or domain');
                return;
            }
            
            formData.append('type', inputType);
            formData.append('targets', inputData);
            
            try {
                const response = await fetch('/scan_certificates', {
                    method: 'POST',
                    body: formData
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    
                    const text = decoder.decode(value);
                    const lines = text.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.error) {
                                    statusText.textContent = `Error: ${data.error}`;
                                    return;
                                }
                                
                                if (data.progress !== undefined) {
                                    const progress = Math.round(data.progress);
                                    progressBar.style.width = `${progress}%`;
                                    progressBar.textContent = `${progress}%`;
                                    statusText.textContent = `Scanning... ${data.processed} of ${data.total} targets`;
                                }
                                
                                if (data.results) {
                                    updateResults(data.results);
                                }
                                
                                if (data.complete) {
                                    statusText.textContent = 'Scan complete!';
                                }
                            } catch (e) {
                                console.error('Error parsing update:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                statusText.textContent = `Error: ${error.message}`;
                console.error('Scan error:', error);
            }
        });

        // Scheduling functionality
        function loadScheduledTasks() {
            fetch('/scheduled_tasks')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('scheduledTasksTable');
                        tbody.innerHTML = '';
                        
                        if (data.tasks.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="5" class="text-center">No scheduled tasks</td>
                                </tr>
                            `;
                            return;
                        }
                        
                        data.tasks.forEach(task => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${task.name}</td>
                                    <td>${task.frequency}</td>
                                    <td>${task.time}</td>
                                    <td>${task.next_run}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                })
                .catch(error => console.error('Error loading scheduled tasks:', error));
        }

        function deleteTask(taskId) {
            fetch(`/scheduled_task/${taskId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadScheduledTasks();
                    } else {
                        alert('Failed to delete task: ' + data.error);
                    }
                })
                .catch(error => console.error('Error deleting task:', error));
        }

        // Store uploaded domains globally
        let uploadedDomains = [];

        // Handle the upload button click
        document.getElementById('uploadDomainsButton').addEventListener('click', async function() {
            const fileInput = document.getElementById('scheduleDomainFile');
            if (fileInput.files.length === 0) {
                alert('Please select a file first');
                return;
            }

            try {
                const file = fileInput.files[0];
                const text = await file.text();
                uploadedDomains = text.split('\n').filter(d => d.trim());
                
                if (uploadedDomains.length === 0) {
                    alert('No valid domains found in file');
                    return;
                }

                // Show the upload info
                document.getElementById('uploadedDomainsCount').textContent = uploadedDomains.length;
                
                // Show preview of domains
                const previewList = document.getElementById('uploadedDomainsList');
                previewList.innerHTML = uploadedDomains
                    .slice(0, 5) // Show first 5 domains
                    .map(domain => `<div>${domain}</div>`)
                    .join('') + 
                    (uploadedDomains.length > 5 ? `<div class="text-muted">...and ${uploadedDomains.length - 5} more</div>` : '');
            } catch (e) {
                console.error('Error loading uploaded domains:', e);
            }
        });

        // Add export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            // Create workbook with two sheets
            const wb = XLSX.utils.book_new();
            
            // Export certificates table
            const certsTable = document.getElementById('certsTable');
            const wsFound = XLSX.utils.table_to_sheet(certsTable);
            XLSX.utils.book_append_sheet(wb, wsFound, "Found Certificates");
            
            // Export failures table
            const failuresTable = document.getElementById('failuresTable');
            const wsFailed = XLSX.utils.table_to_sheet(failuresTable);
            XLSX.utils.book_append_sheet(wb, wsFailed, "Failed/No Certificates");
            
            // Save the file
            XLSX.writeFile(wb, "certificate_scan_results.xlsx");
        });
    </script>

    <!-- Add SheetJS for Excel export -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</body>
</html>