<!DOCTYPE html>
<html>
<head>
    <title>Certificate Checker Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .status-bar {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .progress {
            height: 25px;
        }
        .chart-container {
            width: 400px;
            margin: 20px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1>Certificate Checker Dashboard</h1>
        
        <!-- Input Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Input Domains</h5>
                
                <!-- Tab navigation -->
                <ul class="nav nav-tabs mb-3" id="inputTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab" aria-controls="manual" aria-selected="true">
                            Manual Input
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file" type="button" role="tab" aria-controls="file" aria-selected="false">
                            File Upload
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="scheduled-tab" data-bs-toggle="tab" data-bs-target="#scheduled" type="button" role="tab" aria-controls="scheduled" aria-selected="false">
                            Scheduled Scans
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content" id="inputTabsContent">
                    <!-- Manual Input Tab -->
                    <div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
                        <form id="manualForm">
                            <div class="mb-3">
                                <textarea class="form-control" id="domainList" rows="5" placeholder="Enter domains (one per line)"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Check Domains</button>
                        </form>
                    </div>
                    
                    <!-- File Upload Tab -->
                    <div class="tab-pane fade" id="file" role="tabpanel" aria-labelledby="file-tab">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="domainFile" accept=".txt">
                                <small class="text-muted">Upload a .txt file with one domain per line</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload and Check</button>
                        </form>
                    </div>
                    
                    <!-- Scheduled Scans tab content -->
                    <div class="tab-pane fade" id="scheduled" role="tabpanel" aria-labelledby="scheduled-tab">
                        <div class="card mt-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Scheduled Scans</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                                    <i class="fas fa-plus"></i> New Schedule
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Frequency</th>
                                                <th>Time</th>
                                                <th>Next Run</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scheduledTasksTable">
                                            <!-- Will be populated by loadScheduledTasks() -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Add new section for active scans -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">Active Scans</h5>
                            </div>
                            <div class="card-body" id="activeScans">
                                <div class="no-active-scans text-muted">No scans currently running</div>
                                <!-- Active scans will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="statusBar" class="status-bar bg-light">
            <h5>Progress</h5>
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
            <div id="statusText" class="mt-2">Ready to check certificates...</div>
        </div>

        <!-- Charts Section -->
        <div class="row mt-4">
            <div class="col">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="issuerChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="summary-section" style="display: none; margin-bottom: 20px;">
            <h3>Certificate Scan Summary</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Total Domains Scanned:</strong> <span id="total-domains">0</span></p>
                    <p><strong>Domains with Certificates:</strong> <span id="domains-with-certs">0</span></p>
                    <p><strong>Total Certificates Found:</strong> <span id="total-certificates">0</span></p>
                </div>
                <div class="col-md-6">
                    <h4>Certificate Status Breakdown:</h4>
                    <p><strong>Valid Certificates:</strong> <span id="valid-certs">0</span></p>
                    <p><strong>Expiring Soon:</strong> <span id="expiring-soon">0</span></p>
                    <p><strong>Expired:</strong> <span id="expired">0</span></p>
                    <p><strong>Not Yet Valid:</strong> <span id="not-yet-valid">0</span></p>
                </div>
            </div>
        </div>

        <!-- Results Table Section -->
        <div class="row mt-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Domain Results</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="resultsTable">
                                <thead>
                                    <tr>
                                        <th>Domain</th>
                                        <th>Status</th>
                                        <th>Issuer</th>
                                        <th>Time Until Expiry</th>
                                        <th>Expiration Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export and Schedule Buttons -->
        <div class="mt-4 mb-4">
            <button id="exportButton" class="btn btn-success me-2" style="display: none;">
                Export Results to Excel
            </button>
            <button id="exportHtmlButton" class="btn btn-primary me-2" style="display: none;">
                Export Dashboard to HTML
            </button>
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                <i class="fas fa-clock"></i> Schedule Recurring Scan
            </button>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">Schedule Recurring Scan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <div class="mb-3">
                            <label for="scheduleName" class="form-label">Schedule Name</label>
                            <input type="text" class="form-control" id="scheduleName" required>
                        </div>
                        
                        <!-- Update tab IDs and data attributes -->
                        <ul class="nav nav-tabs mb-3" id="scheduleInputTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="manual-domains-tab" data-bs-toggle="tab" 
                                        data-bs-target="#manual-domains" type="button" role="tab">
                                    Manual Input
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="file-domains-tab" data-bs-toggle="tab" 
                                        data-bs-target="#file-domains" type="button" role="tab">
                                    File Upload
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Update tab content IDs -->
                        <div class="tab-content" id="scheduleInputTabsContent">
                            <div class="tab-pane fade show active" id="manual-domains" role="tabpanel">
                                <div class="mb-3">
                                    <label for="scheduleDomains" class="form-label">Domains to Scan</label>
                                    <textarea class="form-control" id="scheduleDomains" rows="4"
                                              placeholder="Enter domains (one per line)"></textarea>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="file-domains" role="tabpanel">
                                <div class="mb-3">
                                    <label for="scheduleDomainFile" class="form-label">Upload Domains File</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="scheduleDomainFile" accept=".txt">
                                        <button class="btn btn-secondary" type="button" id="uploadDomainsButton">
                                            Upload
                                        </button>
                                    </div>
                                    <small class="text-muted">Upload a .txt file with one domain per line</small>
                                    <div id="uploadedDomainsInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-success">
                                            <span id="uploadedDomainsCount">0</span> domains loaded successfully
                                            <button type="button" class="btn-close float-end" aria-label="Close"></button>
                                        </div>
                                        <div class="border rounded p-2 bg-light">
                                            <small class="text-muted">Preview:</small>
                                            <div id="uploadedDomainsList" style="max-height: 100px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="scheduleFrequency" class="form-label">Frequency</label>
                            <select class="form-select" id="scheduleFrequency" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="scheduleTime" required>
                        </div>
                    </form>
                </div>
                <div class="modal-body" id="scheduledTasksList">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Frequency</th>
                                    <th>Time</th>
                                    <th>Next Run</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by loadScheduledTasks() -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSchedule">Save Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize charts
        const statusChart = new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: {
                labels: ['Valid', 'Warning', 'Expired', 'Not Yet Valid'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Certificate Status Distribution'
                    }
                }
            }
        });

        const issuerChart = new Chart(document.getElementById('issuerChart'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Certificates per Issuer',
                    data: [],
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Top Certificate Issuers'
                    }
                }
            }
        });

        function updateResults(results) {
            console.log('Updating results:', results);
            
            // Make sure the summary section exists
            let summarySection = document.getElementById('summary-section');
            if (!summarySection) {
                console.log('Creating summary section');
                const resultsContainer = document.querySelector('#resultsContainer');
                summarySection = document.createElement('div');
                summarySection.id = 'summary-section';
                resultsContainer.prepend(summarySection);
            }
            
            // Show summary section
            summarySection.style.display = 'block';

            if (!results || results.length === 0) {
                console.log('No results to display');
                summarySection.innerHTML = `
                    <div class="alert alert-info" role="alert">
                        <h4 class="alert-heading">Scan Complete</h4>
                        <p>No certificate results were found for the scanned domains.</p>
                        <hr>
                        <p class="mb-0">This might be because the domains were invalid or unreachable. Please verify your domain list and try again.</p>
                    </div>
                `;
                
                const tbody = document.querySelector('#resultsTable tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>No results available
                            </td>
                        </tr>
                    `;
                }
                
                if (window.certStatusChart) {
                    window.certStatusChart.data.datasets[0].data = [0, 0, 0];
                    window.certStatusChart.update();
                }
                
                return;
            }

            // Calculate statistics
            const total = results.length;
            const valid = results.filter(r => r.valid).length;
            const expiring = results.filter(r => r.expiring).length;
            const expired = results.filter(r => r.expired).length;

            console.log('Statistics:', { total, valid, expiring, expired });

            // Update or create pie chart
            const chartCanvas = document.getElementById('certStatusChart');
            if (chartCanvas) {
                if (window.certStatusChart) {
                    window.certStatusChart.destroy();
                }
                
                window.certStatusChart = new Chart(chartCanvas, {
                    type: 'pie',
                    data: {
                        labels: ['Valid', 'Expiring Soon', 'Expired'],
                        datasets: [{
                            data: [valid, expiring, expired],
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Update results table with export buttons
            const resultsContainer = document.getElementById('resultsContainer');
            if (resultsContainer) {
                // Add export buttons
                const exportButtons = `
                    <div class="mb-3">
                        <button class="btn btn-secondary me-2" onclick="exportToCSV()">
                            <i class="fas fa-file-csv me-2"></i>Export to CSV
                        </button>
                        <button class="btn btn-secondary" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf me-2"></i>Export to PDF
                        </button>
                    </div>
                `;
                
                // Update table
                resultsContainer.innerHTML = `
                    ${exportButtons}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>Issuer</th>
                                    <th>Valid From</th>
                                    <th>Valid Until</th>
                                    <th>Days Remaining</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.map(result => `
                                    <tr class="${getStatusClass(result)}">
                                        <td>${result.domain}</td>
                                        <td>${result.issuer}</td>
                                        <td>${result.valid_from}</td>
                                        <td>${result.valid_until}</td>
                                        <td>${result.days_remaining}</td>
                                        <td>${getStatusBadge(result)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        // Add export functions
        function exportToCSV() {
            const results = Array.from(document.querySelectorAll('#resultsTable tbody tr')).map(row => {
                const cells = Array.from(row.cells);
                return {
                    domain: cells[0].textContent,
                    issuer: cells[1].textContent,
                    validFrom: cells[2].textContent,
                    validUntil: cells[3].textContent,
                    daysRemaining: cells[4].textContent,
                    status: cells[5].textContent.trim()
                };
            });

            const csvContent = [
                ['Domain', 'Issuer', 'Valid From', 'Valid Until', 'Days Remaining', 'Status'].join(','),
                ...results.map(r => [
                    r.domain,
                    r.issuer,
                    r.validFrom,
                    r.validUntil,
                    r.daysRemaining,
                    r.status
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'certificate_scan_results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToPDF() {
            const element = document.getElementById('resultsTable');
            html2pdf()
                .set({
                    margin: 1,
                    filename: 'certificate_scan_results.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
                })
                .from(element)
                .save();
        }

        // Helper functions for status display
        function getStatusClass(result) {
            if (result.expired) return 'table-danger';
            if (result.expiring) return 'table-warning';
            return 'table-success';
        }

        function getStatusBadge(result) {
            if (result.expired) return '<span class="badge bg-danger">Expired</span>';
            if (result.expiring) return '<span class="badge bg-warning">Expiring Soon</span>';
            return '<span class="badge bg-success">Valid</span>';
        }

        function processDomainsWithProgress(formData) {
            $('#statusBar').show();
            $('#progressBar')
                .css('width', '0%')
                .text('0%')
                .removeClass('bg-danger')
                .addClass('progress-bar-striped progress-bar-animated');
            $('#statusText').text('Processing domains...');
            $('#exportButton').hide();
            $('#exportHtmlButton').hide();
            
            // Clear previous results
            $('#summary-section').hide();
            $('#resultsTable tbody').empty();

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/check_certificates', true);
            
            xhr.onprogress = function(e) {
                const lines = xhr.responseText.split('\n');
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            console.log("Progress update:", data);

                            if (data.error) {
                                console.error("Error from server:", data.error);
                                $('#statusText').text('Error: ' + data.error);
                                $('#progressBar').addClass('bg-danger');
                                return;
                            }

                            if (data.progress) {
                                const progress = Math.round(data.progress);
                                $('#progressBar')
                                    .css('width', progress + '%')
                                    .text(progress + '%');
                                $('#statusText').text(
                                    `Processing ${data.current_domain} (${data.processed}/${data.total})`
                                );
                            }

                            if (data.complete) {
                                console.log("Processing complete, updating results");
                                updateResults(data.results);
                                $('#statusText').text('Processing complete!');
                                $('#progressBar')
                                    .css('width', '100%')
                                    .text('100%')
                                    .removeClass('progress-bar-striped progress-bar-animated');
                            }
                        } catch (e) {
                            console.error("Error parsing progress data:", e);
                        }
                    }
                });
            };

            xhr.send(formData);
        }

        // Form handlers
        $('#uploadForm').on('submit', function(e) {
            e.preventDefault();
            const fileInput = $('#domainFile')[0];
            if (fileInput.files.length === 0) {
                alert('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            // Show progress bar
            $('#statusBar').show();
            $('#progressBar')
                .css('width', '0%')
                .text('0%')
                .removeClass('bg-danger')
                .addClass('progress-bar-striped progress-bar-animated');
            $('#statusText').text('Processing domains...');
            
            // Clear previous results
            $('#summary-section').hide();
            $('#resultsTable tbody').empty();

            processDomainsWithProgress(formData);
        });

        $('#manualForm').on('submit', function(e) {
            e.preventDefault();
            const domains = $('#domainList').val();
            if (!domains.trim()) {
                alert('Please enter at least one domain');
                return;
            }

            const blob = new Blob([domains], { type: 'text/plain' });
            const formData = new FormData();
            formData.append('file', blob, 'manual-input.txt');
            processDomainsWithProgress(formData);
        });

        // Scheduling functionality
        function loadScheduledTasks() {
            fetch('/scheduled_tasks')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('scheduledTasksTable');
                        tbody.innerHTML = '';
                        
                        if (data.tasks.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="5" class="text-center">No scheduled tasks</td>
                                </tr>
                            `;
                            return;
                        }
                        
                        data.tasks.forEach(task => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${task.name}</td>
                                    <td>${task.frequency}</td>
                                    <td>${task.time}</td>
                                    <td>${task.next_run}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                })
                .catch(error => console.error('Error loading scheduled tasks:', error));
        }

        function deleteTask(taskId) {
            fetch(`/scheduled_task/${taskId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadScheduledTasks();
                    } else {
                        alert('Failed to delete task: ' + data.error);
                    }
                })
                .catch(error => console.error('Error deleting task:', error));
        }

        // Store uploaded domains globally
        let uploadedDomains = [];

        // Handle the upload button click
        document.getElementById('uploadDomainsButton').addEventListener('click', async function() {
            const fileInput = document.getElementById('scheduleDomainFile');
            if (fileInput.files.length === 0) {
                alert('Please select a file first');
                return;
            }

            try {
                const file = fileInput.files[0];
                const text = await file.text();
                uploadedDomains = text.split('\n').filter(d => d.trim());
                
                if (uploadedDomains.length === 0) {
                    alert('No valid domains found in file');
                    return;
                }

                // Show the upload info
                document.getElementById('uploadedDomainsCount').textContent = uploadedDomains.length;
                
                // Show preview of domains
                const previewList = document.getElementById('uploadedDomainsList');
                previewList.innerHTML = uploadedDomains
                    .slice(0, 5) // Show first 5 domains
                    .map(domain => `<div>${domain}</div>`)
                    .join('') + 
                    (uploadedDomains.length > 5 ? `<div class="text-muted">...and ${uploadedDomains.length - 5} more</div>` : '');
                
                document.getElementById('uploadedDomainsInfo').style.display = 'block';
            } catch (error) {
                console.error('Error reading file:', error);
                alert('Error reading file');
            }
        });

        // Handle closing the upload info
        document.querySelector('#uploadedDomainsInfo .btn-close').addEventListener('click', function() {
            document.getElementById('uploadedDomainsInfo').style.display = 'none';
        });

        // Update the save button handler to use uploadedDomains when in file mode
        document.getElementById('saveSchedule').addEventListener('click', async function() {
            const name = document.getElementById('scheduleName').value;
            const frequency = document.getElementById('scheduleFrequency').value;
            const time = document.getElementById('scheduleTime').value;
            let domains = [];

            // Add debug logging
            console.log('Name:', name);
            console.log('Frequency:', frequency);
            console.log('Time:', time);

            // Check which tab is active
            const isFileUpload = document.querySelector('#file-domains.active') !== null;
            console.log('Is file upload:', isFileUpload);
            
            if (isFileUpload) {
                if (uploadedDomains.length === 0) {
                    alert('Please upload a file with domains first');
                    return;
                }
                domains = uploadedDomains;
            } else {
                const manualDomains = document.getElementById('scheduleDomains').value;
                if (!manualDomains.trim()) {
                    alert('Please enter at least one domain');
                    return;
                }
                domains = manualDomains.split('\n').filter(d => d.trim());
            }

            console.log('Domains:', domains); // Debug log

            // Update validation check
            if (!name) {
                alert('Please enter a schedule name');
                return;
            }
            if (domains.length === 0) {
                alert('Please provide at least one domain');
                return;
            }
            if (!frequency) {
                alert('Please select a frequency');
                return;
            }
            if (!time) {
                alert('Please select a time');
                return;
            }

            fetch('/schedule_scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    domains: domains,
                    frequency: frequency,
                    time: time
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Scan scheduled with job ID:', data.job_id); // Debug log
                    
                    // Start monitoring the scan progress with the returned job ID
                    setupScanProgress(data.job_id, name);
                    
                    alert('Scan scheduled successfully!');
                    loadScheduledTasks();
                    
                    // Reset form and close modal
                    document.getElementById('scheduleForm').reset();
                    uploadedDomains = [];
                    document.getElementById('uploadedDomainsInfo').style.display = 'none';
                    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                } else {
                    alert('Failed to schedule scan: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to schedule scan');
            });
        });

        // Clear uploaded domains when modal is hidden
        document.getElementById('scheduleModal').addEventListener('hidden.bs.modal', function () {
            uploadedDomains = [];
            document.getElementById('uploadedDomainsInfo').style.display = 'none';
        });

        // Load scheduled tasks when the modal is opened
        document.getElementById('scheduleModal').addEventListener('show.bs.modal', function () {
            loadScheduledTasks();
        });

        // Export functionality
        function exportToExcel() {
            const table = document.getElementById('resultsTable');
            let data = [];
            
            // Add summary data
            data.push(['Certificate Scan Summary']);
            data.push([`Total Domains Scanned: ${$('#total-domains').text()}`]);
            data.push([`Domains with Certificates: ${$('#domains-with-certs').text()}`]);
            data.push([`Total Certificates Found: ${$('#total-certificates').text()}`]);
            data.push(['']);
            data.push(['Certificate Status Breakdown:']);
            data.push([`Valid Certificates: ${$('#valid-certs').text()}`]);
            data.push([`Expiring Soon: ${$('#expiring-soon').text()}`]);
            data.push([`Expired: ${$('#expired').text()}`]);
            data.push([`Not Yet Valid: ${$('#not-yet-valid').text()}`]);
            data.push(['']);
            
            // Get headers
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(th.textContent);
            });
            data.push(headers);
            
            // Get table data
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    row.push(td.textContent);
                });
                data.push(row);
            });
            
            const timestamp = new Date().toISOString().slice(0,19).replace(/[:]/g, '-');
            
            fetch('/export_excel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: data,
                    filename: `certificate-check-results-${timestamp}.xlsx`
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `certificate-check-results-${timestamp}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => console.error('Error:', error));
        }

        // Update the click handlers
        $('#exportButton').on('click', exportToExcel);

        // Call loadScheduledTasks when the page loads and when switching to the scheduled tab
        document.addEventListener('DOMContentLoaded', loadScheduledTasks);
        document.querySelector('#scheduled-tab').addEventListener('click', loadScheduledTasks);

        // Add auto-refresh every minute for the scheduled tasks
        setInterval(() => {
            if (document.querySelector('#scheduled-tab').classList.contains('active')) {
                loadScheduledTasks();
            }
        }, 60000);

        // Store active scans
        let activeScans = new Map();

        // Function to update active scans display
        function updateActiveScanDisplay() {
            console.log('Updating active scans display. Current scans:', Array.from(activeScans.entries()));
            const container = document.getElementById('activeScans');
            if (!container) {
                console.error('Active scans container not found!');
                return;
            }

            if (activeScans.size === 0) {
                container.innerHTML = '<div class="text-muted">No scans currently running</div>';
                return;
            }

            container.innerHTML = '';
            activeScans.forEach((scan, scanId) => {
                console.log(`Rendering progress for scan ${scanId}:`, scan);
                container.innerHTML += `
                    <div class="scan-progress mb-3" id="scan-${scanId}">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong>${scan.name}</strong>
                            <span class="badge bg-primary">${scan.processed}/${scan.total} domains</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: ${scan.progress}%" 
                                 aria-valuenow="${scan.progress}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                ${Math.round(scan.progress)}%
                            </div>
                        </div>
                        <small class="text-muted">Current domain: ${scan.currentDomain || 'N/A'}</small>
                    </div>
                `;
            });
        }

        // Set up EventSource for scan progress
        function setupScanProgress(scanId, scanName) {
            console.log(`Setting up progress monitoring for scan: ${scanId}`);
            const eventSource = new EventSource(`/scan_progress/${scanId}`);
            
            eventSource.onmessage = function(event) {
                console.log('Progress update received:', event.data);
                const data = JSON.parse(event.data);
                
                // Update active scans display
                if (!data.complete) {
                    activeScans.set(scanId, {
                        name: scanName,
                        progress: data.progress,
                        processed: data.processed,
                        total: data.total,
                        currentDomain: data.current_domain
                    });
                    updateActiveScanDisplay();
                    
                    // Update results if available
                    if (data.results && data.results.length > 0) {
                        console.log(`Updating with ${data.results.length} results`);
                        updateResults(data.results);
                    }
                } else {
                    // Handle completion
                    console.log('Scan complete:', scanId);
                    eventSource.close();
                    activeScans.delete(scanId);
                    updateActiveScanDisplay();
                    
                    // Final results update
                    if (data.results && data.results.length > 0) {
                        console.log(`Final update with ${data.results.length} results`);
                        updateResults(data.results);
                    } else {
                        console.log('No results in final update');
                        updateResults([]);
                    }
                    
                    // Show completion toast
                    const toast = new bootstrap.Toast(document.getElementById('scanCompleteToast'));
                    document.getElementById('scanCompleteName').textContent = scanName;
                    toast.show();
                }
            };

            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                eventSource.close();
                activeScans.delete(scanId);
                updateActiveScanDisplay();
            };
        }

        // Add toast for scan completion
        document.body.insertAdjacentHTML('beforeend', `
            <div class="toast-container position-fixed bottom-0 end-0 p-3">
                <div id="scanCompleteToast" class="toast" role="alert">
                    <div class="toast-header">
                        <strong class="me-auto">Scan Complete</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        Scan "<span id="scanCompleteName"></span>" has completed.
                    </div>
                </div>
            </div>
        `);

        // Update active scans every 30 seconds
        setInterval(updateActiveScanDisplay, 30000);

        // Make sure the active scans container exists and is visible
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure the active scans container exists
            const scheduledTab = document.getElementById('scheduled');
            if (!scheduledTab.querySelector('#activeScans')) {
                scheduledTab.insertAdjacentHTML('beforeend', `
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0">Active Scans</h5>
                        </div>
                        <div class="card-body" id="activeScans">
                            <div class="no-active-scans text-muted">No scans currently running</div>
                        </div>
                    </div>
                `);
            }
        });
    </script>
</body>

