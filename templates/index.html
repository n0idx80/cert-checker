<!DOCTYPE html>
<html>
<head>
    <title>Certificate Checker Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .status-bar {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .progress {
            height: 25px;
        }
        .chart-container {
            width: 400px;
            margin: 20px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Certificate Checker Dashboard</h1>
        
        <!-- Input Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Input Domains</h5>
                
                <!-- Tab navigation -->
                <ul class="nav nav-tabs mb-3" id="inputTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab" aria-controls="manual" aria-selected="true">
                            Manual Input
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file" type="button" role="tab" aria-controls="file" aria-selected="false">
                            File Upload
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content" id="inputTabsContent">
                    <!-- Manual Input Tab -->
                    <div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
                        <form id="manualForm">
                            <div class="mb-3">
                                <textarea class="form-control" id="domainList" rows="5" placeholder="Enter domains (one per line)"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Check Domains</button>
                        </form>
                    </div>
                    
                    <!-- File Upload Tab -->
                    <div class="tab-pane fade" id="file" role="tabpanel" aria-labelledby="file-tab">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="domainFile" accept=".txt">
                                <small class="text-muted">Upload a .txt file with one domain per line</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload and Check</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="statusBar" class="status-bar bg-light">
            <h5>Progress</h5>
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
            <div id="statusText" class="mt-2">Ready to check certificates...</div>
        </div>

        <!-- Charts Section -->
        <div class="row mt-4">
            <div class="col">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="issuerChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Add this before your results table -->
        <div id="summary-section" style="display: none; margin-bottom: 20px;">
            <h3>Certificate Scan Summary</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Total Domains Scanned:</strong> <span id="total-domains">0</span></p>
                    <p><strong>Domains with Certificates:</strong> <span id="domains-with-certs">0</span></p>
                    <p><strong>Total Certificates Found:</strong> <span id="total-certificates">0</span></p>
                </div>
                <div class="col-md-6">
                    <h4>Certificate Status Breakdown:</h4>
                    <p><strong>Valid Certificates:</strong> <span id="valid-certs">0</span></p>
                    <p><strong>Expiring Soon:</strong> <span id="expiring-soon">0</span></p>
                    <p><strong>Expired:</strong> <span id="expired">0</span></p>
                    <p><strong>Not Yet Valid:</strong> <span id="not-yet-valid">0</span></p>
                </div>
            </div>
        </div>

        <!-- Results Table Section -->
        <div class="row mt-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Domain Results</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="resultsTable">
                                <thead>
                                    <tr>
                                        <th>Domain</th>
                                        <th>Status</th>
                                        <th>Issuer</th>
                                        <th>Time Until Expiry</th>
                                        <th>Expiration Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Button -->
        <div class="mt-4 mb-4">
            <button id="exportButton" class="btn btn-success me-2" style="display: none;">
                Export Results to Excel
            </button>
            <button id="exportHtmlButton" class="btn btn-primary" style="display: none;">
                Export Dashboard to HTML
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize charts
        const statusChart = new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: {
                labels: ['Valid', 'Warning', 'Expired', 'Not Yet Valid'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Certificate Status Distribution'
                    }
                }
            }
        });

        const issuerChart = new Chart(document.getElementById('issuerChart'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Certificates per Issuer',
                    data: [],
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Top Certificate Issuers'
                    }
                }
            }
        });

        function updateResults(results) {
            console.log("Updating results:", results);
            
            let statusCounts = {
                'Valid': 0,
                'Warning': 0,
                'Expired': 0,
                'Not Yet Valid': 0
            };
            
            let issuerCounts = {};
            
            // Clear existing table rows
            $('#resultsTable tbody').empty();
            
            // Show the summary section
            $('#summary-section').show();
            
            // Update summary counts
            $('#total-domains').text(results.length);
            let domainsWithCerts = results.filter(r => r.Status).length;
            $('#domains-with-certs').text(domainsWithCerts);
            $('#total-certificates').text(results.length);
            
            results.forEach(result => {
                // Update status counts
                if (result.Status === 'Valid') statusCounts['Valid']++;
                else if (result.Status === 'Expiring Soon') statusCounts['Warning']++;
                else if (result.Status === 'Expired') statusCounts['Expired']++;
                else if (result.Status === 'Not Yet Valid') statusCounts['Not Yet Valid']++;
                
                // Update issuer counts
                if (result.Issuer) {
                    issuerCounts[result.Issuer] = (issuerCounts[result.Issuer] || 0) + 1;
                }
                
                // Add row to table
                $('#resultsTable tbody').append(`
                    <tr class="${getStatusClass(result.Status)}">
                        <td>${result.Domain}</td>
                        <td>${result.Status}</td>
                        <td>${result.Issuer || 'N/A'}</td>
                        <td>${result['Time Until Expiry'] || 'N/A'}</td>
                        <td>${result['Expiration Date'] || 'N/A'}</td>
                    </tr>
                `);
            });
            
            // Update status summary
            $('#valid-certs').text(statusCounts['Valid']);
            $('#expiring-soon').text(statusCounts['Warning']);
            $('#expired').text(statusCounts['Expired']);
            $('#not-yet-valid').text(statusCounts['Not Yet Valid']);
            
            // Update charts
            statusChart.data.datasets[0].data = Object.values(statusCounts);
            statusChart.update();
            
            // Update Issuer Chart
            const sortedIssuers = Object.entries(issuerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            issuerChart.data.labels = sortedIssuers.map(item => item[0]);
            issuerChart.data.datasets[0].data = sortedIssuers.map(item => item[1]);
            issuerChart.update();
            
            console.log("Summary counts:", statusCounts);
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Valid':
                    return 'table-success';
                case 'Expiring Soon':
                    return 'table-warning';
                case 'Expired':
                    return 'table-danger';
                case 'Not Yet Valid':
                    return 'table-info';
                default:
                    return '';
            }
        }

        function processDomainsWithProgress(formData) {
            $('#statusBar').show();
            $('#progressBar')
                .css('width', '0%')
                .text('0%')
                .removeClass('bg-danger')
                .addClass('progress-bar-striped progress-bar-animated');
            $('#statusText').text('Processing domains...');
            $('#exportButton').hide();
            
            // Clear previous results
            $('#summary-section').hide();
            $('#resultsTable tbody').empty();

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/check_certificates', true);
            
            xhr.onprogress = function(e) {
                const lines = xhr.responseText.split('\n');
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            console.log("Progress update:", data);

                            if (data.error) {
                                console.error("Error from server:", data.error);
                                $('#statusText').text('Error: ' + data.error);
                                $('#progressBar').addClass('bg-danger');
                                return;
                            }

                            if (data.progress) {
                                const progress = Math.round(data.progress);
                                $('#progressBar')
                                    .css('width', progress + '%')
                                    .text(progress + '%');
                                $('#statusText').text(
                                    `Processing ${data.current_domain} (${data.processed}/${data.total})`
                                );
                            }

                            if (data.complete) {
                                console.log("Processing complete, updating results");
                                updateResults(data.results);
                                $('#statusText').text('Processing complete!');
                                $('#progressBar')
                                    .css('width', '100%')
                                    .text('100%')
                                    .removeClass('progress-bar-striped progress-bar-animated');
                                $('#exportButton').show();
                                $('#exportHtmlButton').show();
                            }
                        } catch (e) {
                            console.error("Error parsing progress data:", e);
                        }
                    }
                });
            };

            xhr.send(formData);
        }

        // Form handlers
        $('#uploadForm').on('submit', function(e) {
            e.preventDefault();
            const fileInput = $('#domainFile')[0];
            if (fileInput.files.length === 0) {
                alert('Please select a file first');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            processDomainsWithProgress(formData);
        });

        $('#manualForm').on('submit', function(e) {
            e.preventDefault();
            const domains = $('#domainList').val();
            if (!domains.trim()) {
                alert('Please enter at least one domain');
                return;
            }

            const blob = new Blob([domains], { type: 'text/plain' });
            const formData = new FormData();
            formData.append('file', blob, 'manual-input.txt');
            processDomainsWithProgress(formData);
        });

        function displayResults(data) {
            if (data.success) {
                // Update summary section
                document.getElementById('summary-section').style.display = 'block';
                document.getElementById('total-domains').textContent = data.summary.total_domains;
                document.getElementById('domains-with-certs').textContent = data.summary.domains_with_certs;
                document.getElementById('total-certificates').textContent = data.summary.total_certificates;
                document.getElementById('valid-certs').textContent = data.summary.valid_certs;
                document.getElementById('expiring-soon').textContent = data.summary.expiring_soon;
                document.getElementById('expired').textContent = data.summary.expired;
                document.getElementById('not-yet-valid').textContent = data.summary.not_yet_valid;
                
                // Your existing table population code...
            } else {
                // ... error handling ...
            }
        }

        function exportToHtml() {
            // Get the current date and time for the filename
            const now = new Date();
            const timestamp = now.toISOString().slice(0,19).replace(/[:]/g, '-');
            
            // Create a new HTML document with Bootstrap and current styling
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Certificate Check Results - ${timestamp}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        .chart-container {
                            width: 400px;
                            margin: 20px;
                            display: inline-block;
                        }
                        ${document.querySelector('style').innerHTML}
                        /* Add table-specific styling */
                        .table-responsive {
                            overflow-x: auto;
                        }
                        .table {
                            width: 100%;
                            margin-bottom: 1rem;
                        }
                        /* Preserve status colors */
                        .table-success { background-color: rgba(40, 167, 69, 0.1); }
                        .table-warning { background-color: rgba(255, 193, 7, 0.1); }
                        .table-danger { background-color: rgba(220, 53, 69, 0.1); }
                        .table-info { background-color: rgba(23, 162, 184, 0.1); }
                    </style>
                </head>
                <body>
                    <div class="container mt-4">
                        <h1>Certificate Check Results</h1>
                        <p class="text-muted">Generated on: ${now.toLocaleString()}</p>
                        
                        <!-- Summary Section -->
                        ${document.getElementById('summary-section').outerHTML}
                        
                        <!-- Charts Section -->
                        <div class="row mt-4">
                            <div class="col">
                                ${document.querySelector('.chart-container').parentElement.outerHTML}
                            </div>
                        </div>
                        
                        <!-- Results Table -->
                        <div class="row mt-4">
                            <div class="col">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Domain Results</h5>
                                        <div class="table-responsive">
                                            ${document.getElementById('resultsTable').outerHTML}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
                    <script>
                        window.onload = function() {
                            const statusChartData = ${JSON.stringify(statusChart.data)};
                            const issuerChartData = ${JSON.stringify(issuerChart.data)};
                            const statusChartOptions = ${JSON.stringify(statusChart.options)};
                            const issuerChartOptions = ${JSON.stringify(issuerChart.options)};
                            
                            new Chart(document.getElementById('statusChart'), {
                                type: 'pie',
                                data: statusChartData,
                                options: statusChartOptions
                            });
                            
                            new Chart(document.getElementById('issuerChart'), {
                                type: 'bar',
                                data: issuerChartData,
                                options: issuerChartOptions
                            });
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            // Create a Blob containing the HTML content
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            
            // Create a link to download the HTML file
            const a = document.createElement('a');
            a.href = url;
            a.download = `certificate-check-results-${timestamp}.html`;
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Add click handler for the HTML export button
        $('#exportHtmlButton').on('click', exportToHtml);
    </script>
</body>
</html> 