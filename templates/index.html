<!DOCTYPE html>
<html>
<head>
    <title>Certificate Checker Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .status-bar {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .progress {
            height: 25px;
        }
        .chart-container {
            width: 400px;
            margin: 20px;
            display: inline-block;
        }
        .table-responsive {
            margin-bottom: 2rem;
        }
        
        .table td {
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 0;
        }
        
        .table th {
            background-color: #f8f9fa;
        }
        
        /* Add tooltip-like hover for truncated content */
        td.text-truncate:hover {
            position: relative;
        }
        
        td.text-truncate[title]:hover:after {
            content: attr(title);
            position: absolute;
            left: 0;
            top: 100%;
            z-index: 1000;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: normal;
            word-wrap: break-word;
            max-width: 400px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Certificate Checker Dashboard</h1>
            <div class="btn-group">
                <button id="exportExcelBtn" class="btn btn-success me-2">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button id="exportTextBtn" class="btn btn-primary me-2">
                    <i class="fas fa-file-alt"></i> Export to Text
                </button>
                <button id="exportDashboardBtn" class="btn btn-info">
                    <i class="fas fa-download"></i> Save Dashboard
                </button>
            </div>
        </div>
        
        <!-- Input Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Input Domains</h5>
                
                <!-- Tab navigation -->
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" 
                                data-bs-target="#manual" type="button" role="tab" 
                                aria-controls="manual" aria-selected="true">
                            Site Cert Scanner
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="file-tab" data-bs-toggle="tab" 
                                data-bs-target="#file" type="button" role="tab" 
                                aria-controls="file" aria-selected="false">
                            Public CTL Checker
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="scheduled-tab" data-bs-toggle="tab" 
                                data-bs-target="#scheduled" type="button" role="tab" 
                                aria-controls="scheduled" aria-selected="false">
                            Scheduled Scans
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content" id="inputTabsContent">
                    <!-- Manual Input Tab -->
                    <div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
                        <form id="manualForm" class="mt-4">
                            <div class="mb-3">
                                <label for="inputData" class="form-label">Enter URLs/Domains (one per line)</label>
                                <textarea class="form-control" id="inputData" rows="5" 
                                          placeholder="Enter one URL or domain per line"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="urlFileInput" class="form-label">Or upload a file (one URL per line)</label>
                                <input type="file" class="form-control" id="urlFileInput" 
                                       accept=".txt,.csv,.list">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Scan Certificates</button>
                        </form>

                        <div id="progressSection" style="display: none;" class="mt-4">
                            <h4 id="statusText">Starting scan...</h4>
                            <div class="progress" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" 
                                     aria-valuemax="100">0%</div>
                            </div>
                        </div>

                        <!-- Add this right after the progress bar section and before the results tables -->
                        <div class="row mt-4" id="summary-section" style="display: none;">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h4>Certificate Status Distribution</h4>
                                        <div class="chart-container">
                                            <canvas id="certStatusChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h4>Summary</h4>
                                        <p><strong>Total Scanned:</strong> <span id="total-count">0</span></p>
                                        <p><strong>Valid:</strong> <span id="valid-count">0</span></p>
                                        <p><strong>Expiring Soon (<90 days):</strong> <span id="expiring-soon-count">0</span></p>
                                        <p><strong>Expired:</strong> <span id="expired-count">0</span></p>
                                        <p><strong>Invalid:</strong> <span id="invalid-count">0</span></p>
                                        <p><strong>Failed/No Certificate:</strong> <span id="failed-count">0</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <!-- Update the Found Certificates table -->
                            <div class="table-responsive mt-4">
                                <h3>Found Certificates</h3>
                                <table id="certsTable" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%">Target</th>
                                            <th style="width: 10%">Status</th>
                                            <th style="width: 15%">Common Name</th>
                                            <th style="width: 30%">Alternative Names</th>
                                            <th style="width: 15%">Issuer</th>
                                            <th style="width: 8%">Expiry</th>
                                            <th style="width: 7%">Days</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            
                            <!-- Update the Failed/No Certificates table -->
                            <div class="table-responsive mt-4">
                                <h3>Failed/No Certificates</h3>
                                <table id="failuresTable" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%">Target</th>
                                            <th style="width: 15%">Status</th>
                                            <th style="width: 55%">Error</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Upload Tab -->
                    <div class="tab-pane fade" id="file" role="tabpanel" aria-labelledby="file-tab">
                        <div class="container mt-4">
                            <div class="row">
                                <!-- Manual Input Column -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">Manual Input</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="ctlManualForm">
                                                <div class="mb-3">
                                                    <label for="manualDomains" class="form-label">Enter Domains</label>
                                                    <textarea class="form-control" id="manualDomains" rows="10" 
                                                        placeholder="Enter domains (one per line)"></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Query CT Logs</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- File Upload Column -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">File Upload</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="ctlFileForm">
                                                <div class="mb-3">
                                                    <label for="domainFile" class="form-label">Upload Domains List</label>
                                                    <input type="file" class="form-control" id="domainFile" accept=".txt">
                                                    <small class="text-muted">Upload a .txt file with one domain per line</small>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Query CT Logs</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress and Results Sections -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <!-- Progress Section -->
                                    <div id="ctlProgressSection" style="display: none;">
                                        <h4 id="ctlStatusText">Querying CT logs...</h4>
                                        <div class="progress" style="height: 25px;">
                                            <div id="ctlProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" 
                                                 aria-valuemax="100">0%</div>
                                        </div>
                                    </div>

                                    <!-- Results Section -->
                                    <div id="ctlResultsSection" style="display: none;" class="mt-4">
                                        <h4>Certificate Transparency Log Results</h4>
                                        <div class="row mt-4">
                                            <div class="col-md-8">
                                                <table id="ctlResultsTable" class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Domain</th>
                                                            <th>Common Name</th>
                                                            <th>Status</th>
                                                            <th>Issuer</th>
                                                            <th>Expiration Date</th>
                                                            <th>Time Until Expiry</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                            <div class="col-md-4">
                                                <canvas id="ctlPieChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scheduled Scans tab content -->
                    <div class="tab-pane fade" id="scheduled" role="tabpanel" aria-labelledby="scheduled-tab">
                        <div class="card mt-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Scheduled Scans</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                                    <i class="fas fa-plus"></i> New Schedule
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Frequency</th>
                                                <th>Time</th>
                                                <th>Next Run</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scheduledTasksTable">
                                            <!-- Will be populated by loadScheduledTasks() -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Add new section for active scans -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">Active Scans</h5>
                            </div>
                            <div class="card-body" id="activeScans">
                                <div class="no-active-scans text-muted">No scans currently running</div>
                                <!-- Active scans will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="statusBar" class="status-bar bg-light">
            <h5>Progress</h5>
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
            <div id="statusText" class="mt-2">Ready to check certificates...</div>
        </div>

        <!-- Charts Section -->
        <div class="row mt-4">
            <div class="col">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="issuerChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="summary-section" style="display: none; margin-bottom: 20px;">
            <h3>Certificate Scan Summary</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Total Domains Scanned:</strong> <span id="total-domains">0</span></p>
                    <p><strong>Domains with Certificates:</strong> <span id="domains-with-certs">0</span></p>
                    <p><strong>Total Certificates Found:</strong> <span id="total-certificates">0</span></p>
                </div>
                <div class="col-md-6">
                    <h4>Certificate Status Breakdown:</h4>
                    <p><strong>Valid Certificates:</strong> <span id="valid-certs">0</span></p>
                    <p><strong>Expiring Soon:</strong> <span id="expiring-soon">0</span></p>
                    <p><strong>Expired:</strong> <span id="expired">0</span></p>
                    <p><strong>Not Yet Valid:</strong> <span id="not-yet-valid">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">Schedule Recurring Scan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <div class="mb-3">
                            <label for="scheduleName" class="form-label">Schedule Name</label>
                            <input type="text" class="form-control" id="scheduleName" required>
                        </div>
                        
                        <!-- Update tab IDs and data attributes -->
                        <ul class="nav nav-tabs mb-3" id="scheduleInputTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="manual-domains-tab" data-bs-toggle="tab" 
                                        data-bs-target="#manual-domains" type="button" role="tab">
                                    Manual Input
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="file-domains-tab" data-bs-toggle="tab" 
                                        data-bs-target="#file-domains" type="button" role="tab">
                                    File Upload
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Update tab content IDs -->
                        <div class="tab-content" id="scheduleInputTabsContent">
                            <div class="tab-pane fade show active" id="manual-domains" role="tabpanel">
                                <div class="mb-3">
                                    <label for="scheduleDomains" class="form-label">Domains to Scan</label>
                                    <textarea class="form-control" id="scheduleDomains" rows="4"
                                              placeholder="Enter domains (one per line)"></textarea>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="file-domains" role="tabpanel">
                                <div class="mb-3">
                                    <label for="scheduleDomainFile" class="form-label">Upload Domains File</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="scheduleDomainFile" accept=".txt">
                                        <button class="btn btn-secondary" type="button" id="uploadDomainsButton">
                                            Upload
                                        </button>
                                    </div>
                                    <small class="text-muted">Upload a .txt file with one domain per line</small>
                                    <div id="uploadedDomainsInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-success">
                                            <span id="uploadedDomainsCount">0</span> domains loaded successfully
                                            <button type="button" class="btn-close float-end" aria-label="Close"></button>
                                        </div>
                                        <div class="border rounded p-2 bg-light">
                                            <small class="text-muted">Preview:</small>
                                            <div id="uploadedDomainsList" style="max-height: 100px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="scheduleFrequency" class="form-label">Frequency</label>
                            <select class="form-select" id="scheduleFrequency" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="scheduleTime" required>
                        </div>
                    </form>
                </div>
                <div class="modal-body" id="scheduledTasksList">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Frequency</th>
                                    <th>Time</th>
                                    <th>Next Run</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by loadScheduledTasks() -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSchedule">Save Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize chart globally
        let certStatusChart = null;

        // Create a global stats object to maintain totals
        let globalStats = {
            total: 0,            // This will be set from backend's total
            valid: 0,
            expiringSoon: 0,
            expired: 0,
            invalid: 0,
            failed: 0
        };

        // Add this function to update total from backend
        function updateGlobalTotal(total) {
            globalStats.total = total;
        }

        // Create the chart as soon as the page loads
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('certStatusChart');
            if (ctx) {
                certStatusChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Valid', 'Expiring Soon', 'Expired', 'Invalid'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                '#28a745', // Valid - Green
                                '#ffc107', // Expiring Soon - Yellow
                                '#fd7e14', // Expired - Orange
                                '#dc3545', // Invalid - Red
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
                console.log('Chart initialized successfully');
            } else {
                console.error('Could not find chart canvas element');
            }
        });

        // Change batch size from 1000 to 200
        const BATCH_SIZE = 200; // Process 200 results at a time

        // Add these functions before the form event listener
        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            
            // Update progress bar
            const progress = Math.round(data.progress);
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            
            // Update status text
            statusText.textContent = `Processing ${data.current_url} (${data.total_processed} of ${data.total_urls})`;
        }

        function showError(message) {
            const statusText = document.getElementById('statusText');
            statusText.textContent = `Error: ${message}`;
            statusText.style.color = 'red';
            
            // Reset progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '0%';
            progressBar.classList.remove('progress-bar-animated');
        }

        function updateResults(results) {
            console.log("Updating results:", results);
            
            const certsTable = document.querySelector('#certsTable tbody');
            const failuresTable = document.querySelector('#failuresTable tbody');
            
            // Clear existing rows
            certsTable.innerHTML = '';
            failuresTable.innerHTML = '';
            
            results.forEach(result => {
                if (result.status === 'invalid' || result.error) {
                    // Add to failures table
                    const row = failuresTable.insertRow();
                    row.innerHTML = `
                        <td>${result.url}</td>
                        <td>${result.status}</td>
                        <td>${result.error || 'Unknown error'}</td>
                    `;
                } else {
                    // Add to certificates table
                    const row = certsTable.insertRow();
                    const certInfo = result.cert_info;
                    row.innerHTML = `
                        <td>${result.url}</td>
                        <td>${result.status}</td>
                        <td>${result.normalized_url || ''}</td>
                        <td>${certInfo.issuer || ''}</td>
                        <td>${certInfo.expiry_date || ''}</td>
                        <td>${certInfo.days_until_expiry || ''}</td>
                    `;
                }
            });
            
            // Update summary stats
            if (results.length > 0) {
                document.getElementById('summary-section').style.display = 'flex';
                updateStats(results);
            }
        }

        function updateStats(results) {
            const stats = {
                valid: results.filter(r => r.status === 'valid').length,
                expiring_soon: results.filter(r => r.status === 'expiring_soon').length,
                expired: results.filter(r => r.status === 'expired').length,
                invalid: results.filter(r => r.status === 'invalid').length
            };
            
            // Update counts
            document.getElementById('valid-count').textContent = stats.valid;
            document.getElementById('expiring-soon-count').textContent = stats.expiring_soon;
            document.getElementById('expired-count').textContent = stats.expired;
            document.getElementById('invalid-count').textContent = stats.invalid;
            document.getElementById('total-count').textContent = results.length;
            
            // Update chart if it exists
            if (certStatusChart) {
                certStatusChart.data.datasets[0].data = [
                    stats.valid,
                    stats.expiring_soon,
                    stats.expired,
                    stats.invalid
                ];
                certStatusChart.update();
            }
        }

        // Add table management
        let certTableBody, failureTableBody;
        const MAX_VISIBLE_ROWS = 1000; // Limit visible rows

        function initializeTables() {
            certTableBody = document.querySelector('#certsTable tbody');
            failureTableBody = document.querySelector('#failuresTable tbody');
            
            // Clear existing rows
            certTableBody.innerHTML = '';
            failureTableBody.innerHTML = '';
        }

        function addTableRow(table, rowHTML) {
            const tbody = table.querySelector('tbody');
            
            // Remove oldest row if at limit
            if (tbody.children.length >= MAX_VISIBLE_ROWS) {
                tbody.removeChild(tbody.firstChild);
            }
            
            // Add new row
            const row = document.createElement('tr');
            row.innerHTML = rowHTML;
            tbody.appendChild(row);
        }

        // Update form submission to handle large files
        document.getElementById('manualForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Reset stats and UI
            globalStats = {
                valid: 0,
                expiringSoon: 0,
                expired: 0,
                invalid: 0,
                failed: 0
            };
            
            initializeTables();
            document.getElementById('summary-section').style.display = 'flex';
            
            const formData = new FormData();
            const fileInput = document.getElementById('urlFileInput');
            const textInput = document.getElementById('inputData');
            
            // Check if we have a file or text input
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            } else if (textInput.value.trim()) {
                // Create a blob from text input
                const blob = new Blob([textInput.value], { type: 'text/plain' });
                formData.append('file', blob, 'urls.txt');
            } else {
                alert('Please either enter URLs or upload a file');
                return;
            }
            
            // Show processing message
            const progressSection = document.getElementById('progressSection');
            progressSection.style.display = 'block';
            const statusText = document.getElementById('statusText');
            statusText.textContent = 'Processing URLs...';
            
            try {
                const response = await fetch('/check_certificates', {
                    method: 'POST',
                    body: formData
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    
                    const lines = decoder.decode(value).split('\n');
                    for (const line of lines) {
                        if (!line.trim() || !line.startsWith('data: ')) continue;
                        
                        console.log("Received SSE update:", line);  // Debug log
                        
                        const data = JSON.parse(line.substring(6));
                        if (data.error) {
                            console.error("Error:", data.error);  // Debug log
                            showError(data.error);
                            return;
                        }
                        
                        console.log("Processing update:", data);  // Debug log
                        updateProgress(data);
                        if (data.results) {
                            console.log("Updating results with:", data.results);  // Debug log
                            updateResults(data.results);
                        }
                    }
                }
            } catch (error) {
                console.error("Fetch error:", error);  // Debug log
                showError('Error processing URLs: ' + error);
            }
        });

        // Add file input handler to clear textarea when file is selected
        document.getElementById('urlFileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                document.getElementById('inputData').value = '';
            }
        });

        // Add textarea handler to clear file input when text is entered
        document.getElementById('inputData').addEventListener('input', function(e) {
            if (e.target.value.trim()) {
                document.getElementById('urlFileInput').value = '';
            }
        });

        // Scheduling functionality
        function loadScheduledTasks() {
            fetch('/scheduled_tasks')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('scheduledTasksTable');
                        tbody.innerHTML = '';
                        
                        if (data.tasks.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="5" class="text-center">No scheduled tasks</td>
                                </tr>
                            `;
                            return;
                        }
                        
                        data.tasks.forEach(task => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${task.name}</td>
                                    <td>${task.frequency}</td>
                                    <td>${task.time}</td>
                                    <td>${task.next_run}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                })
                .catch(error => console.error('Error loading scheduled tasks:', error));
        }

        function deleteTask(taskId) {
            fetch(`/scheduled_task/${taskId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadScheduledTasks();
                    } else {
                        alert('Failed to delete task: ' + data.error);
                    }
                })
                .catch(error => console.error('Error deleting task:', error));
        }

        // Store uploaded domains globally
        let uploadedDomains = [];

        // Handle the upload button click
        document.getElementById('uploadDomainsButton').addEventListener('click', async function() {
            const fileInput = document.getElementById('scheduleDomainFile');
            if (fileInput.files.length === 0) {
                alert('Please select a file first');
                return;
            }

            try {
                const file = fileInput.files[0];
                const text = await file.text();
                uploadedDomains = text.split('\n').filter(d => d.trim());
                
                if (uploadedDomains.length === 0) {
                    alert('No valid domains found in file');
                    return;
                }

                // Show the upload info
                document.getElementById('uploadedDomainsCount').textContent = uploadedDomains.length;
                
                // Show preview of domains
                const previewList = document.getElementById('uploadedDomainsList');
                previewList.innerHTML = uploadedDomains
                    .slice(0, 5) // Show first 5 domains
                    .map(domain => `<div>${domain}</div>`)
                    .join('') + 
                    (uploadedDomains.length > 5 ? `<div class="text-muted">...and ${uploadedDomains.length - 5} more</div>` : '');
            } catch (e) {
                console.error('Error loading uploaded domains:', e);
            }
        });

        // Export functionality
        const exportHandlers = {
            excel: function() {
                try {
                    console.log('Starting Excel export...');
                    const wb = XLSX.utils.book_new();
                    
                    // Process CTL certificates
                    const ctlTable = document.querySelector('#ctlResultsTable tbody');
                    if (!ctlTable) {
                        console.log('No CTL results table found');
                        throw new Error('CTL results table not found');
                    }
                    
                    const ctlData = Array.from(ctlTable.querySelectorAll('tr')).map(row => {
                        return {
                            'Domain': row.cells[0]?.textContent || '',
                            'Common Name': row.cells[1]?.textContent || '',
                            'Status': row.cells[2]?.textContent || '',
                            'Issuer': row.cells[3]?.textContent || '',
                            'Expiration Date': row.cells[4]?.textContent || '',
                            'Time Until Expiry': row.cells[5]?.textContent || ''
                        };
                    });
                    
                    if (ctlData.length > 0) {
                        const wsFound = XLSX.utils.json_to_sheet(ctlData);
                        XLSX.utils.book_append_sheet(wb, wsFound, "CT Log Results");
                        
                        console.log('Writing file...');
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        XLSX.writeFile(wb, `ct_log_scan_${timestamp}.xlsx`);
                    } else {
                        alert('No data to export');
                    }
                    
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    alert('Error exporting to Excel. Please check the console for details.');
                }
            },

            text: function() {
                const ctlTable = document.querySelector('#ctlResultsTable tbody');
                if (!ctlTable || ctlTable.rows.length === 0) {
                    alert('No data to export');
                    return;
                }

                let output = "Certificate Transparency Log Results\n";
                output += "===================================\n\n";
                
                Array.from(ctlTable.rows).forEach(row => {
                    output += `Domain: ${row.cells[0].textContent}\n`;
                    output += `Common Name: ${row.cells[1].textContent}\n`;
                    output += `Status: ${row.cells[2].textContent}\n`;
                    output += `Issuer: ${row.cells[3].textContent}\n`;
                    output += `Expiration Date: ${row.cells[4].textContent}\n`;
                    output += `Time Until Expiry: ${row.cells[5].textContent}\n`;
                    output += "-----------------------------------\n";
                });
                
                // Create and trigger download
                const blob = new Blob([output], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const a = document.createElement('a');
                a.href = url;
                a.download = `ct_log_scan_${timestamp}.txt`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            },

            dashboard: function() {
                const dashboard = document.querySelector('.container').cloneNode(true);
                const chartDataStr = JSON.stringify(certStatusChart.data).replace(/`/g, '\\`');
                const chartOptionsStr = JSON.stringify(certStatusChart.options).replace(/`/g, '\\`');
                
                const html = `<!DOCTYPE html>
<html>
<head>
    <title>Certificate Scan Dashboard - ${new Date().toLocaleDateString()}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .chart-container { height: 300px; }
    </style>
</head>
<body>
    ${dashboard.outerHTML}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    <script>
        const chartData = ${chartDataStr};
        const chartOptions = ${chartOptionsStr};
        const ctx = document.getElementById('certStatusChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'pie',
                data: chartData,
                options: chartOptions
            });
        }
    <\/script>
</body>
</html>`; // Note the escaped closing script tags
                
                const blob = new Blob([html], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const a = document.createElement('a');
                a.href = url;
                a.download = `certificate_dashboard_${timestamp}.html`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        };

        // Add event listeners
        document.getElementById('exportExcelBtn').addEventListener('click', exportHandlers.excel);
        document.getElementById('exportTextBtn').addEventListener('click', exportHandlers.text);
        document.getElementById('exportDashboardBtn').addEventListener('click', exportHandlers.dashboard);

        // Function to handle CT log queries (used by both forms)
        async function handleCTLQuery(formData) {
            const statusText = document.getElementById('ctlStatus') || document.createElement('div');
            if (!document.getElementById('ctlStatus')) {
                statusText.id = 'ctlStatus';
                document.getElementById('ctlResultsSection').prepend(statusText);
            }
            
            statusText.textContent = 'Starting CT Log query...';
            
            try {
                const response = await fetch('/query_ctl', {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    
                    const lines = decoder.decode(value).split('\n');
                    for (const line of lines) {
                        if (!line.trim() || !line.startsWith('data: ')) continue;
                        
                        try {
                            const jsonStr = line.substring(6);
                            const data = JSON.parse(jsonStr);
                            
                            if (data.error) {
                                statusText.textContent = `Error: ${data.error}`;
                                return;
                            }

                            statusText.textContent = `Processing domain ${data.current_domain} (${Math.round(data.progress)}%)`;
                            
                            if (data.results && data.results.length > 0) {
                                updateCTLResults(data.results);
                            }

                            if (data.complete) {
                                statusText.textContent = 'CT Log query complete!';
                            }
                        } catch (e) {
                            // Only log parsing errors in console if needed
                            console.debug('Parse error:', e);
                        }
                    }
                }
            } catch (e) {
                console.debug('Network or processing error:', e);
                statusText.textContent = 'Query completed with some errors';
            }
        }

        // File upload form handler
        document.getElementById('ctlFileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('domainFile');
            if (!fileInput.files.length) {
                alert('Please select a file to upload');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            await handleCTLQuery(formData);
        });

        // Manual input form handler
        document.getElementById('ctlManualForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const domainsText = document.getElementById('manualDomains').value.trim();
            if (!domainsText) {
                alert('Please enter at least one domain');
                return;
            }

            const formData = new FormData();
            const blob = new Blob([domainsText], { type: 'text/plain' });
            formData.append('file', blob, 'domains.txt');
            await handleCTLQuery(formData);
        });

        function updateCTLResults(results) {
            const resultsSection = document.getElementById('ctlResultsSection');
            resultsSection.style.display = 'block';
            
            const tbody = document.querySelector('#ctlResultsTable tbody');
            tbody.innerHTML = ''; // Clear existing results
            
            // Initialize status counts for pie chart
            const statusCounts = {
                'Valid': 0,
                'Expiring Soon': 0,
                'Expired': 0,
                'Not Yet Valid': 0
            };
            
            results.forEach(result => {
                const row = document.createElement('tr');
                
                // Add status-based highlighting
                row.classList.add(getStatusClass(result.Status));
                
                row.innerHTML = `
                    <td>${result.Domain || ''}</td>
                    <td>${result['Common Name'] || ''}</td>
                    <td>${result.Status || ''}</td>
                    <td>${result.Issuer || ''}</td>
                    <td>${result['Expiration Date'] || ''}</td>
                    <td>${result['Days Until Expiry'] || ''}</td>
                `;
                tbody.appendChild(row);
                
                // Update status counts for pie chart
                if (result.Status in statusCounts) {
                    statusCounts[result.Status]++;
                }
            });
            
            // Create/update pie chart
            createCTLPieChart(statusCounts);
        }
        
        function getStatusClass(status) {
            switch (status) {
                case 'Expired':
                    return 'table-danger';
                case 'Expiring Soon':
                    return 'table-warning';
                case 'Not Yet Valid':
                    return 'table-info';
                case 'Valid':
                    return 'table-success';
                default:
                    return '';
            }
        }
        
        function createCTLPieChart(statusCounts) {
            const ctx = document.getElementById('ctlPieChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.ctlPieChart) {
                window.ctlPieChart.destroy();
            }
            
            window.ctlPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#28a745',  // Valid - green
                            '#ffc107',  // Expiring Soon - yellow
                            '#dc3545',  // Expired - red
                            '#17a2b8'   // Not Yet Valid - blue
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Certificate Status Distribution'
                        }
                    }
                }
            });
        }

        function viewCertDetails(domain) {
            // We'll implement this function later to show certificate details
            console.log(`Viewing details for ${domain}`);
        }
    </script>
</body>
</html>